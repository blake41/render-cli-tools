#!/usr/bin/env bash
# linear-cli - Linear issue management for AI agents
# Linear API is GraphQL-based, this provides convenient commands

set -euo pipefail

CONFIG_DIR="${HOME}/.config/linear"
API_URL="https://api.linear.app/graphql"

# Get API key from config or environment
get_api_key() {
  if [[ -n "${LINEAR_API_KEY:-}" ]]; then
    echo "$LINEAR_API_KEY"
  elif [[ -f "$CONFIG_DIR/api-key" ]]; then
    cat "$CONFIG_DIR/api-key"
  else
    echo "âŒ No Linear API key found" >&2
    echo "   Set LINEAR_API_KEY or create ~/.config/linear/api-key" >&2
    echo "   Get your key from: Linear Settings â†’ Security & access â†’ API keys" >&2
    exit 1
  fi
}

# Execute GraphQL query
graphql() {
  local query="$1"
  local api_key
  api_key=$(get_api_key)
  
  curl -s -X POST \
    -H "Content-Type: application/json" \
    -H "Authorization: $api_key" \
    --data "{\"query\": \"$query\"}" \
    "$API_URL"
}

usage() {
  cat <<EOF
linear-cli - Linear issue management for AI agents

USAGE
  linear-cli <command> [options]

COMMANDS
  issues [--mine] [--project NAME] [--status STATUS] [--limit N]
      List issues with optional filters
      
  issue <ID>
      Get details for a specific issue (e.g., "ENG-123")
      
  search <query>
      Search issues by text
      
  create <team-key> "<title>" [--description "..."] [--priority 1-4]
      Create a new issue (auto-assigned to you)
      
  projects
      List all projects
      
  teams
      List all teams
      
  me
      Show current user info

EXAMPLES
  # Read operations
  linear-cli issues --mine --limit 10
  linear-cli issues --project "Q1 Roadmap" --status "In Progress"
  linear-cli issue ENG-123
  linear-cli search "authentication bug"
  linear-cli projects
  linear-cli teams
  
  # Create issues (auto-assigned to you)
  linear-cli create GTM "Fix login bug"
  linear-cli create GTM "Add dark mode" --description "User requested feature" --priority 2

SETUP
  1. Go to Linear Settings â†’ Security & access â†’ API keys
  2. Create a new personal API key
  3. Save it:
     echo "lin_api_xxxxx" > ~/.config/linear/api-key
     chmod 600 ~/.config/linear/api-key

OUTPUT
  Returns JSON for easy parsing by agents
EOF
  exit 1
}

# Commands
cmd_me() {
  graphql "{ viewer { id name email admin } }" | jq '.data.viewer'
}

cmd_teams() {
  graphql "{ teams { nodes { id name key description } } }" | jq '.data.teams.nodes'
}

cmd_projects() {
  graphql "{ projects(first: 50) { nodes { id name description state { name } lead { name } targetDate } } }" | jq '.data.projects.nodes'
}

cmd_issue() {
  local issue_id="$1"
  # Parse identifier like "GTM-3424" into team key and number
  local team_key="${issue_id%-*}"
  local number="${issue_id##*-}"
  
  if [[ ! "$number" =~ ^[0-9]+$ ]]; then
    echo "âŒ Invalid issue ID format. Expected: TEAM-123 (e.g., GTM-3424)" >&2
    exit 1
  fi
  
  graphql "{ issues(filter: { number: { eq: $number }, team: { key: { eq: \\\"$team_key\\\" } } }, first: 1) { nodes { id identifier title description state { name } priority assignee { name } project { name } labels { nodes { name } } createdAt updatedAt } } }" | jq '.data.issues.nodes[0] // empty'
}

cmd_search() {
  local query="$1"
  # Escape quotes in search query
  query=$(echo "$query" | sed 's/"/\\\\"/g')
  graphql "{ searchIssues(term: \\\"$query\\\", first: 20) { nodes { id identifier title state { name } assignee { name } priority } } }" | jq '.data.searchIssues.nodes'
}

# Get current user's ID (cached for session)
get_my_id() {
  graphql "{ viewer { id } }" | jq -r '.data.viewer.id'
}

# Get team ID from team key
get_team_id() {
  local team_key="$1"
  local result
  result=$(graphql "{ teams(filter: { key: { eq: \\\"$team_key\\\" } }) { nodes { id } } }")
  local team_id
  team_id=$(echo "$result" | jq -r '.data.teams.nodes[0].id // empty')
  
  if [[ -z "$team_id" ]]; then
    echo "âŒ Team '$team_key' not found. Run 'linear-cli teams' to see available teams." >&2
    exit 1
  fi
  echo "$team_id"
}

cmd_create() {
  local team_key="$1"
  local title="$2"
  shift 2
  
  local description=""
  local priority=""
  
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --description|-d) description="$2"; shift 2 ;;
      --priority|-p) priority="$2"; shift 2 ;;
      *) echo "Unknown option: $1" >&2; exit 1 ;;
    esac
  done
  
  # Get team ID and user ID
  local team_id
  team_id=$(get_team_id "$team_key")
  local my_id
  my_id=$(get_my_id)
  
  # Build input fields
  local input_fields="teamId: \\\"$team_id\\\", title: \\\"$title\\\", assigneeId: \\\"$my_id\\\""
  
  if [[ -n "$description" ]]; then
    # Escape quotes and newlines in description
    description=$(echo "$description" | sed 's/"/\\\\"/g' | tr '\n' ' ')
    input_fields="$input_fields, description: \\\"$description\\\""
  fi
  
  if [[ -n "$priority" ]]; then
    input_fields="$input_fields, priority: $priority"
  fi
  
  echo "ðŸ“ Creating issue in $team_key..." >&2
  
  local result
  result=$(graphql "mutation { issueCreate(input: { $input_fields }) { success issue { id identifier title url state { name } assignee { name } } } }")
  
  # Check for errors
  if echo "$result" | jq -e '.errors' > /dev/null 2>&1; then
    echo "$result" | jq -r '.errors[0].message // "Unknown error"' >&2
    exit 1
  fi
  
  local success
  success=$(echo "$result" | jq -r '.data.issueCreate.success')
  
  if [[ "$success" != "true" ]]; then
    echo "âŒ Failed to create issue" >&2
    echo "$result" | jq >&2
    exit 1
  fi
  
  echo "$result" | jq '.data.issueCreate.issue'
}

cmd_issues() {
  local mine=""
  local project=""
  local status=""
  local limit=20
  
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --mine) mine="true"; shift ;;
      --project) project="$2"; shift 2 ;;
      --status) status="$2"; shift 2 ;;
      --limit) limit="$2"; shift 2 ;;
      *) echo "Unknown option: $1" >&2; exit 1 ;;
    esac
  done
  
  # Build filter
  local filter=""
  local filters=()
  
  if [[ -n "$mine" ]]; then
    filters+=("assignee: { isMe: { eq: true } }")
  fi
  
  if [[ -n "$status" ]]; then
    filters+=("state: { name: { eq: \\\"$status\\\" } }")
  fi
  
  if [[ -n "$project" ]]; then
    filters+=("project: { name: { eq: \\\"$project\\\" } }")
  fi
  
  if [[ ${#filters[@]} -gt 0 ]]; then
    filter="filter: { $(IFS=', '; echo "${filters[*]}") }, "
  fi
  
  graphql "{ issues(${filter}first: $limit, orderBy: updatedAt) { nodes { id identifier title state { name } priority assignee { name } project { name } updatedAt } } }" | jq '.data.issues.nodes'
}

# Main
[[ $# -lt 1 ]] && usage

CMD="$1"
shift

case "$CMD" in
  me) cmd_me ;;
  teams) cmd_teams ;;
  projects) cmd_projects ;;
  issue)
    [[ $# -lt 1 ]] && { echo "Usage: linear-cli issue <ID>"; exit 1; }
    cmd_issue "$1"
    ;;
  search)
    [[ $# -lt 1 ]] && { echo "Usage: linear-cli search <query>"; exit 1; }
    cmd_search "$*"
    ;;
  issues) cmd_issues "$@" ;;
  create)
    [[ $# -lt 2 ]] && { echo "Usage: linear-cli create <team-key> \"<title>\" [--description \"...\"] [--priority 1-4]"; exit 1; }
    cmd_create "$@"
    ;;
  help|--help|-h) usage ;;
  *) echo "Unknown command: $CMD"; usage ;;
esac


