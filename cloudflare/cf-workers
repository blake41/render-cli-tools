#!/bin/bash
set -euo pipefail

source "$(dirname "$0")/cf-common.sh"

cmd_list() {
    echo "Workers:"
    echo "========"
    
    # Try wrangler first (handles OAuth)
    if command -v wrangler &>/dev/null; then
        # List from current directory's wrangler.jsonc files if in a project
        if [[ -d "workers" ]]; then
            for dir in workers/*/; do
                if [[ -f "${dir}wrangler.jsonc" ]] || [[ -f "${dir}wrangler.toml" ]]; then
                    local name=$(basename "$dir")
                    echo "$name"
                fi
            done
        else
            # Use API to list all workers
            load_api_token || {
                echo "Note: Set CLOUDFLARE_API_TOKEN to list all account workers" >&2
                echo "Currently showing workers from current project only" >&2
                return 0
            }
            
            local account_id
            account_id=$(load_account_id)
            
            cf_api "/accounts/$account_id/workers/scripts" | \
                jq -r '.result[]? | "\(.id)\t\(.modified_on)"' | \
                column -t -s $'\t'
        fi
    fi
}

cmd_info() {
    local worker_name="${1:-}"
    if [[ -z "$worker_name" ]]; then
        echo "Usage: cf-workers info <worker-name>" >&2
        exit 1
    fi
    
    load_api_token || {
        echo "Error: CLOUDFLARE_API_TOKEN required for worker info" >&2
        exit 1
    }
    
    local account_id
    account_id=$(load_account_id)
    
    cf_api "/accounts/$account_id/workers/scripts/$worker_name" | jq '.'
}

cmd_deployments() {
    local worker_name="${1:-}"
    if [[ -z "$worker_name" ]]; then
        echo "Usage: cf-workers deployments <worker-name>" >&2
        exit 1
    fi
    
    load_api_token || {
        echo "Error: CLOUDFLARE_API_TOKEN required for deployments" >&2
        exit 1
    }
    
    local account_id
    account_id=$(load_account_id)
    
    cf_api "/accounts/$account_id/workers/scripts/$worker_name/deployments" | \
        jq -r '.result.deployments[]? | "\(.id[:8])\t\(.created_on)\t\(.author_email)"' | \
        column -t -s $'\t' | head -10
}

case "${1:-help}" in
    list|ls)
        cmd_list
        ;;
    info)
        cmd_info "${2:-}"
        ;;
    deployments|deploys)
        cmd_deployments "${2:-}"
        ;;
    *)
        echo "Usage: cf-workers <command> [args]"
        echo ""
        echo "Commands:"
        echo "  list                  List workers"
        echo "  info <name>           Get worker details"
        echo "  deployments <name>    List recent deployments"
        ;;
esac
